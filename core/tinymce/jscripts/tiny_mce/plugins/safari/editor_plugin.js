(function(){var a=tinymce.dom.Event,d=tinymce.grep,e=tinymce.each,c=tinymce.inArray,b=tinymce.isOldWebKit;function f(j,i,h){var g,k;g=j.createTreeWalker(i,NodeFilter.SHOW_ALL,null,false);while(k=g.nextNode()){if(h){if(!h(k)){return false}}if(k.nodeType==3&&k.nodeValue&&/[^\s\u00a0]+/.test(k.nodeValue)){return false}if(k.nodeType==1&&/^(HR|IMG|TABLE)$/.test(k.nodeName)){return false}}return true}tinymce.create("tinymce.plugins.Safari",{init:function(g){var h=this,i;if(!tinymce.isWebKit){return}h.editor=g;h.webKitFontSizes=["x-small","small","medium","large","x-large","xx-large","-webkit-xxx-large"];h.namedFontSizes=["xx-small","x-small","small","medium","large","x-large","xx-large"];g.addCommand("CreateLink",function(l,k){var o=g.selection.getNode(),m=g.dom,j;if(o&&(/^(left|right)$/i.test(m.getStyle(o,"float",1))||/^(left|right)$/i.test(m.getAttrib(o,"align")))){j=m.create("a",{href:k},o.cloneNode());o.parentNode.replaceChild(j,o);g.selection.select(j)}else{g.getDoc().execCommand("CreateLink",false,k)}});g.onPaste.add(function(j,l){function k(m){m=m.target;if(m.nodeType==1){m.style.cssText="";e(j.dom.select("*",m),function(n){n.style.cssText=""})}}a.add(j.getDoc(),"DOMNodeInserted",k);window.setTimeout(function(){a.remove(j.getDoc(),"DOMNodeInserted",k)},0)});g.onKeyUp.add(function(k,p){var m,j,o,q,l;if(p.keyCode==46||p.keyCode==8){j=k.getBody();m=j.innerHTML;l=k.selection;if(j.childNodes.length==1&&!/<(img|hr)/.test(m)&&tinymce.trim(m.replace(/<[^>]+>/g,"")).length==0){k.setContent('<p><br mce_bogus="1" /></p>',{format:"raw"});q=j.firstChild;o=l.getRng();o.setStart(q,0);o.setEnd(q,0);l.setRng(o)}}});g.addCommand("FormatBlock",function(k,j){var m=g.dom,l=m.getParent(g.selection.getNode(),m.isBlock);if(l){m.replace(m.create(j),l,1)}else{g.getDoc().execCommand("FormatBlock",false,j)}});g.addCommand("mceInsertContent",function(k,j){g.getDoc().execCommand("InsertText",false,"mce_marker");g.getBody().innerHTML=g.getBody().innerHTML.replace(/mce_marker/g,g.dom.processHTML(j)+'<span id="_mce_tmp">XX</span>');g.selection.select(g.dom.get("_mce_tmp"));g.getDoc().execCommand("Delete",false," ")});g.onKeyPress.add(function(p,q){var s,x,t,m,k,l,j,w,o,v,u;if(q.keyCode==13){j=p.selection;s=j.getNode();if(q.shiftKey||p.settings.force_br_newlines&&s.nodeName!="LI"){h._insertBR(p);a.cancel(q)}if(x=i.getParent(s,"LI")){t=i.getParent(x,"OL,UL");w=p.getDoc();u=i.create("p");i.add(u,"br",{mce_bogus:"1"});if(f(w,x)){if(l=i.getParent(t.parentNode,"LI,OL,UL")){return}l=i.getParent(t,"p,h1,h2,h3,h4,h5,h6,div")||t;m=w.createRange();m.setStartBefore(l);m.setEndBefore(x);k=w.createRange();k.setStartAfter(x);k.setEndAfter(l);o=m.cloneContents();v=k.cloneContents();if(!f(w,v)){i.insertAfter(v,l)}i.insertAfter(u,l);if(!f(w,o)){i.insertAfter(o,l)}i.remove(l);l=u.firstChild;m=w.createRange();m.setStartBefore(l);m.setEndBefore(l);j.setRng(m);return a.cancel(q)}}}});g.onExecCommand.add(function(j,l){var k,n,o,m;if(l=="InsertUnorderedList"||l=="InsertOrderedList"){k=j.selection;n=j.dom;if(o=n.getParent(k.getNode(),function(p){return/^(H[1-6]|P|ADDRESS|PRE)$/.test(p.nodeName)})){m=k.getBookmark();n.remove(o,1);k.moveToBookmark(m)}}});g.onClick.add(function(j,k){k=k.target;if(k.nodeName=="IMG"){h.selElm=k;j.selection.select(k)}else{h.selElm=null}});g.onInit.add(function(){h._fixWebKitSpans();if(b){h._patchSafari2x(g)}});g.onSetContent.add(function(){i=g.dom;e(["strong","b","em","u","strike","sub","sup","a"],function(j){e(d(i.select(j)).reverse(),function(m){var l=m.nodeName.toLowerCase(),k;if(l=="a"){if(m.name){i.replace(i.create("img",{mce_name:"a",name:m.name,"class":"mceItemAnchor"}),m)}return}switch(l){case"b":case"strong":if(l=="b"){l="strong"}k="font-weight: bold;";break;case"em":k="font-style: italic;";break;case"u":k="text-decoration: underline;";break;case"sub":k="vertical-align: sub;";break;case"sup":k="vertical-align: super;";break;case"strike":k="text-decoration: line-through;";break}i.replace(i.create("span",{mce_name:l,style:k,"class":"Apple-style-span"}),m,1)})})});g.onPreProcess.add(function(j,k){i=j.dom;e(d(k.node.getElementsByTagName("span")).reverse(),function(o){var l,m;if(k.get){if(i.hasClass(o,"Apple-style-span")){m=o.style.backgroundColor;switch(i.getAttrib(o,"mce_name")){case"font":if(!j.settings.convert_fonts_to_spans){i.setAttrib(o,"style","")}break;case"strong":case"em":case"sub":case"sup":i.setAttrib(o,"style","");break;case"strike":case"u":if(!j.settings.inline_styles){i.setAttrib(o,"style","")}else{i.setAttrib(o,"mce_name","")}break;default:if(!j.settings.inline_styles){i.setAttrib(o,"style","")}}if(m){o.style.backgroundColor=m}}}if(i.hasClass(o,"mceItemRemoved")){i.remove(o,1)}})});g.onPostProcess.add(function(j,k){k.content=k.content.replace(/<br \/><\/(h[1-6]|div|p|address|pre)>/g,"</$1>");k.content=k.content.replace(/ id=\"undefined\"/g,"")})},getInfo:function(){return{longname:"Safari compatibility",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/safari",version:tinymce.majorVersion+"."+tinymce.minorVersion}},_fixWebKitSpans:function(){var h=this,g=h.editor;if(!b){a.add(g.getDoc(),"DOMNodeInserted",function(i){i=i.target;if(i&&i.nodeType==1){h._fixAppleSpan(i)}})}else{g.onExecCommand.add(function(){e(g.dom.select("span"),function(i){h._fixAppleSpan(i)});g.nodeChanged()})}},_fixAppleSpan:function(m){var h=this.editor,n=h.dom,j=this.webKitFontSizes,g=this.namedFontSizes,k=h.settings,i,l;if(n.getAttrib(m,"mce_fixed")){return}if(m.nodeName=="SPAN"&&m.className=="Apple-style-span"){i=m.style;if(!k.convert_fonts_to_spans){if(i.fontSize){n.setAttrib(m,"mce_name","font");n.setAttrib(m,"size",c(j,i.fontSize)+1)}if(i.fontFamily){n.setAttrib(m,"mce_name","font");n.setAttrib(m,"face",i.fontFamily)}if(i.color){n.setAttrib(m,"mce_name","font");n.setAttrib(m,"color",n.toHex(i.color))}if(i.backgroundColor){n.setAttrib(m,"mce_name","font");n.setStyle(m,"background-color",i.backgroundColor)}}else{if(i.fontSize){n.setStyle(m,"fontSize",g[c(j,i.fontSize)])}}if(i.fontWeight=="bold"){n.setAttrib(m,"mce_name","strong")}if(i.fontStyle=="italic"){n.setAttrib(m,"mce_name","em")}if(i.textDecoration=="underline"){n.setAttrib(m,"mce_name","u")}if(i.textDecoration=="line-through"){n.setAttrib(m,"mce_name","strike")}if(i.verticalAlign=="super"){n.setAttrib(m,"mce_name","sup")}if(i.verticalAlign=="sub"){n.setAttrib(m,"mce_name","sub")}n.setAttrib(m,"mce_fixed","1")}},_patchSafari2x:function(h){var i=this,j,l,k=h.dom,g;if(h.windowManager.onBeforeOpen){h.windowManager.onBeforeOpen.add(function(){r=h.selection.getRng()})}h.selection.select=function(m){this.getSel().setBaseAndExtent(m,0,m,1)};l=h.selection.getNode;h.selection.getNode=function(){return i.selElm||l.call(this)};h.selection.getRng=function(){var n=this,o=n.getSel(),w=h.getDoc(),q,u,v,p;if(o.anchorNode){q=w.createRange();try{u=w.createRange();u.setStart(o.anchorNode,o.anchorOffset);u.collapse(1);v=w.createRange();v.setStart(o.focusNode,o.focusOffset);v.collapse(1);p=u.compareBoundaryPoints(u.START_TO_END,v)<0;q.setStart(p?o.anchorNode:o.focusNode,p?o.anchorOffset:o.focusOffset);q.setEnd(p?o.focusNode:o.anchorNode,p?o.focusOffset:o.anchorOffset);g=q}catch(m){}}return q||g};j=h.selection.setContent;h.selection.setContent=function(p,o){var q=this.getRng(),m;try{j.call(this,p,o)}catch(n){m=k.create("body");m.innerHTML=p;e(m.childNodes,function(s){q.insertNode(s.cloneNode(true))})}}},_insertBR:function(g){var k=g.dom,i=g.selection,j=i.getRng(),h;j.insertNode(h=k.create("br"));j.setStartAfter(h);j.setEndAfter(h);i.setRng(j);if(i.getSel().focusNode==h.previousSibling){i.select(k.insertAfter(k.doc.createTextNode("\u00a0"),h));i.collapse(1)}g.getWin().scrollTo(0,k.getPos(i.getRng().startContainer).y)}});tinymce.PluginManager.add("safari",tinymce.plugins.Safari)})();